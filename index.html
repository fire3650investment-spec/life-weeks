<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Life Weeks — 人生週點陣</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1115;
  --fg:#e9edf6;
  --muted:#a7b1c5;
  --panel:#161b26cc;
  --dot-on:#8ba2ff;
  --dot-off:#2a3145;
  --accent:#6a7dff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--fg);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 20px; gap:12px; position:sticky; top:0; z-index:3;
  background:linear-gradient(180deg, rgba(15,17,21,.95), rgba(15,17,21,.75) 70%, rgba(15,17,21,0));
  border-bottom:1px solid rgba(255,255,255,.06);
  backdrop-filter: blur(8px);
}
.h1{font-size:clamp(18px,3.4vw,28px); font-weight:800; letter-spacing:.02em}
.sub{font-size:12px; color:var(--muted)}
.controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.btn{
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg,#2a3358,#1b223f);
  color:var(--fg); border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer;
}
.btn.ghost{background:transparent}
.container{display:grid; grid-template-columns: 1fr 340px; gap:18px; padding:18px; max-width:1400px; margin:0 auto}
@media (max-width: 980px){ .container{grid-template-columns:1fr} }
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.14));
  border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; backdrop-filter: blur(6px);
  box-shadow:0 20px 60px rgba(0,0,0,.35);
  scroll-margin-top: 96px; /* 備援 */
}

/* 統計 */
.statline{display:flex; gap:16px; flex-wrap:wrap; font-size:14px; margin-bottom:8px}
.statline b{font-size:16px}
.progress-line{font-size:15px; font-weight:700; color:#9dc6ff; margin-bottom:8px}
.progress-line b{ font-size:18px }
.mantra{margin:10px 0 14px 0; font-size:13px; color:#cbd6ff; background:rgba(106,125,255,.08); border:1px solid rgba(106,125,255,.25); padding:10px 12px; border-radius:10px}

.legend{display:flex; gap:14px; align-items:center; flex-wrap:wrap; font-size:13px; color:var(--muted); margin-bottom:10px}
.badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12)}
.dot{width:12px; height:12px; border-radius:50%}

.grid{
  --size:12;
  --gap:8;
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(calc(var(--size)*1px), 1fr));
  gap: var(--gap)*1px;
}
.grid .w{
  width: calc(var(--size)*1px); height: calc(var(--size)*1px);
  border-radius:50%;
  background:var(--dot-off);
  box-shadow: inset 0 1px 1px rgba(255,255,255,.06), 0 1px 2px rgba(0,0,0,.3);
  position:relative;
}
.grid .w.on{ background:var(--dot-on); }
.tooltip{
  position:absolute; left:50%; top:-10px; transform:translate(-50%,-100%);
  background:#0f1320; color:#dfe7ff; padding:6px 8px; border-radius:8px; font-size:11px;
  border:1px solid rgba(255,255,255,.12); white-space:nowrap; display:none;
}
.grid .w:hover .tooltip{display:block}

.panel{position:sticky; top:96px}
.panel h3{margin:0 0 10px 0; font-size:14px; letter-spacing:.16em; color:#c7d0e2; text-transform:uppercase}
.row{display:flex; gap:10px; margin-bottom:10px; align-items:center}
.row label{width:92px; font-size:13px; color:#cdd5e7}
.row input, .row select{
  flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
  background:#0f1320; color:#e8ecf1; font-size:14px; outline:none;
}
.hint{font-size:12px; color:var(--muted); margin-top:6px}
.sep{height:1px; background:rgba(255,255,255,.08); margin:12px 0}
</style>
</head>
<body>
  <div class="header" id="appHeader">
    <div>
      <div class="h1">人生週點陣 Life Weeks</div>
      <div class="sub">珍惜每分每秒，珍惜每一次人生相遇</div>
    </div>
    <div class="controls">
      <button class="btn" id="shareBtn" type="button">產生分享連結</button>
      <button class="btn ghost" id="invertBtn" type="button">切換：顯示已過 / 剩餘</button>
      <button class="btn ghost" id="resetBtn" type="button" title="清除本機設定">重置設定</button>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div id="stats"></div>
      <div class="mantra" id="mantra" style="display:none"></div>
      <div class="legend">
        <span class="badge"><span class="dot" style="background:var(--dot-on)"></span> <span id="legendOn">已過</span></span>
        <span class="badge"><span class="dot" style="background:var(--dot-off)"></span> <span id="legendOff">剩餘</span></span>
        <span class="small" id="rangeText"></span>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </div>

    <div class="card panel">
      <h3>設定</h3>
      <div class="row"><label for="birth">生日</label><input id="birth" type="date"/></div>
      <div class="row"><label for="sex">性別</label>
        <select id="sex">
          <option value="male">男（77）</option>
          <option value="female">女（84）</option>
          <option value="custom">自訂</option>
        </select>
      </div>
      <div class="row"><label for="life">壽命（年）</label><input id="life" type="number" min="1" max="130" step="1" value="77"/></div>
      <div class="row"><label for="mode">顯示模式</label>
        <select id="mode">
          <option value="elapsed">點亮已過的週</option>
          <option value="remaining" selected>點亮剩餘的週</option>
        </select>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn" id="applyBtn" type="button">套用</button>
        <button class="btn ghost" id="todayBtn" type="button">跳到今天位置</button>
      </div>
      <div class="hint">提示：選「男/女」會自動調整壽命（77/84），也可自訂覆寫；每個點 = 一週。</div>
    </div>
  </div>

<script>
/* ---------- DOM 快取 ---------- */
const els = {
  header: document.getElementById('appHeader'),
  stats: document.getElementById('stats'),
  grid: document.getElementById('grid'),
  mantra: document.getElementById('mantra'),
  rangeText: document.getElementById('rangeText'),
  legendOn: document.getElementById('legendOn'),
  legendOff: document.getElementById('legendOff'),
  apply: document.getElementById('applyBtn'),
  today: document.getElementById('todayBtn'),
  share: document.getElementById('shareBtn'),
  invert: document.getElementById('invertBtn'),
  reset: document.getElementById('resetBtn'),
  birth: document.getElementById('birth'),
  sex: document.getElementById('sex'),
  life: document.getElementById('life'),
  mode: document.getElementById('mode')
};

/* ---------- 常數 / 儲存 ---------- */
const STORAGE_KEY='lifeWeeksSettings.v1';

/* ---------- 狀態 ---------- */
let state={birth:null,sex:'male',life:77,mode:'remaining',startDate:null,endDate:null,totalWeeks:0,elapsedWeeks:0};

/* ---------- 工具 ---------- */
function addYears(d,y){const n=new Date(d);n.setFullYear(n.getFullYear()+y);return n;}
function weeksBetween(a,b){return Math.max(0,Math.floor((b-a)/(7*24*60*60*1000)));}
function fmtDate(d){return d.toISOString().slice(0,10);}
function saveToStorage(){
  const data={birth:els.birth.value,sex:els.sex.value,life:els.life.value,mode:els.mode.value};
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
}
function loadFromStorage(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
    const d=JSON.parse(raw);
    if(d.birth) els.birth.value=d.birth;
    if(d.sex) els.sex.value=d.sex;
    if(d.life) els.life.value=d.life;
    if(d.mode) els.mode.value=d.mode;
  }catch(e){}
}

/* ---------- 主流程 ---------- */
function applyFromUI(){
  state.birth=els.birth.value?new Date(els.birth.value+'T00:00:00'):null;
  state.sex=els.sex.value;
  let life=parseInt(els.life.value||'0',10);
  if(state.sex==='male') life=77;
  if(state.sex==='female') life=84;
  state.life=Math.min(Math.max(life||0,1),130);
  state.mode=els.mode.value;

  if(state.birth){
    state.startDate=new Date(state.birth);
    state.endDate=addYears(state.startDate,state.life);
    state.totalWeeks=weeksBetween(state.startDate,state.endDate)+1;
    state.elapsedWeeks=weeksBetween(state.startDate,new Date());
  }else{
    state.startDate=null; state.endDate=null; state.totalWeeks=0; state.elapsedWeeks=0;
  }
}

function renderStats(){
  if(!state.startDate){
    els.stats.innerHTML='';
    els.rangeText.textContent='';
    els.mantra.style.display='none';
    return;
  }
  const pct=Math.round((state.elapsedWeeks/state.totalWeeks)*100);
  els.stats.innerHTML=`
    <div class="progress-line">人生進度：<b>${pct}%</b></div>
    <div class="statline">
      <div>總週數：<b>${state.totalWeeks.toLocaleString()}</b></div>
      <div>已過週數：<b>${Math.min(state.elapsedWeeks,state.totalWeeks).toLocaleString()}</b></div>
      <div>剩餘週數：<b>${Math.max(0,state.totalWeeks-state.elapsedWeeks).toLocaleString()}</b></div>
    </div>`;
  els.legendOn.textContent = state.mode==='elapsed'?'已過':'剩餘';
  els.legendOff.textContent = state.mode==='elapsed'?'剩餘':'已過';
  els.rangeText.textContent = `範圍：${fmtDate(state.startDate)} → ${fmtDate(state.endDate)}`;
}

function renderGrid(){
  els.grid.innerHTML='';
  if(!state.startDate) return;
  const today=new Date();
  for(let i=0;i<state.totalWeeks;i++){
    const w=document.createElement('div');w.className='w';
    const weekStart=new Date(state.startDate.getTime()+i*7*24*60*60*1000);
    const weekEnd=new Date(weekStart.getTime()+6*24*60*60*1000);
    const elapsed=(today>=weekEnd);
    const on=(state.mode==='elapsed')?elapsed:!elapsed;
    if(on) w.classList.add('on');
    w.title=`第 ${i+1} 週｜${fmtDate(weekStart)} ~ ${fmtDate(weekEnd)}`;
    els.grid.appendChild(w);
  }
}

function scrollStatsIntoViewIfMobile(){
  if(!window.matchMedia('(max-width:980px)').matches) return;
  requestAnimationFrame(()=>{setTimeout(()=>{
    if(!els.stats) return;
    const headerH=els.header?els.header.getBoundingClientRect().height:0;
    const y=els.stats.getBoundingClientRect().top+window.scrollY-headerH-8;
    window.scrollTo({top:y,behavior:'smooth'});
  },0);});
}

/* ---------- 事件 ---------- */
els.apply.addEventListener('click',()=>{
  applyFromUI(); renderStats(); renderGrid(); saveToStorage();
  scrollStatsIntoViewIfMobile();
});
els.invert.addEventListener('click',()=>{
  els.mode.value = (els.mode.value==='elapsed')?'remaining':'elapsed';
  applyFromUI(); renderStats(); renderGrid(); saveToStorage();
  scrollStatsIntoViewIfMobile();
});
els.today.addEventListener('click',()=>{
  if(!state.startDate) return;
  const i=Math.min(state.elapsedWeeks,state.totalWeeks-1);
  els.grid.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});
});
els.reset.addEventListener('click',()=>{
  // 1) 清本機儲存
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  // 2) 清網址參數
  if(history.replaceState){
    try{ history.replaceState(null,'',location.pathname); }catch(e){}
  }
  // 3) 還原輸入
  els.birth.value='';
  els.sex.value='male';
  els.life.value='77';
  els.mode.value='remaining';
  // 4) 重新渲染（會清空統計與圓點）
  applyFromUI(); renderStats(); renderGrid();
  // 5) 使用者回饋
  const old=els.reset.textContent; els.reset.textContent='已重置';
  setTimeout(()=>els.reset.textContent=old,1200);
});
els.share.addEventListener('click',()=>{
  const url=new URL(location.href);
  const sp=new URLSearchParams();
  if(els.birth.value) sp.set('birth',els.birth.value);
  if(els.sex.value) sp.set('sex',els.sex.value);
  if(els.life.value) sp.set('life',els.life.value);
  if(els.mode.value) sp.set('mode',els.mode.value);
  url.search=sp.toString();
  navigator.clipboard?.writeText(url.toString()).then(()=>{
    const old=els.share.textContent; els.share.textContent='已複製連結';
    setTimeout(()=>els.share.textContent=old,1200);
  });
});

/* ---------- 啟動 ---------- */
loadFromStorage();
applyFromUI();
renderStats();
renderGrid();
</script>
</body>
</html>
